# 前因

小米Mix2手机运行家园时，手机发热严重

  

# 工具和分析

## 分析工具：Snapdragon Profilter/Profile
![[（图解18）GPU性能profile.png]]
前置文档阅读：GPU显存：[GPU内存](https://o455xcugsp.feishu.cn/wiki/DvGhwM79CiYHLZk6F4gcuiOQn2d)

**部分关键指标：**
- ALU/Vertex（顶点着色器算术逻辑单元指令数）
- ALU/Fragment（片元着色器算术逻辑单元指令数）
- **% L1 Hit（L1****缓存命中率****）**
- **L1 Texture Miss%（L1纹理未命中率）**
- **L2 Texture Miss%（L2纹理未命中率）**
- Kernel Load Cycles%（内核加载周期占比）
- **Write Total (Bytes/****sec****)（每秒总写入带宽）**
- **Read Total (Bytes/****sec****)（每秒总读取带宽）**
- Texture Fetch Stall%（纹理获取停顿率）
# 数据采集和分析
## 优化前的数据
![[（图解19）纹理缓存丢失.PNG]]
![[（图解20）单元指令数.png]]
![[（图解21）读写数据.PNG|660]]
![[（图解22）LI缓存命中率.png|660]]
![[（图解23）纹理获取停顿率.png|660]]
![[（图解24）内核加载周期.png|660]]
![[（图解25）顶点加载周期.PNG]]
![[（图解26）frame debugger.png]]
![[（图解26）frame debugger1.png]]
![[（图解27）frame debugger2.png]]

## 数据分析

**当前游戏的关键指标数据：**

- % L1 Hit：均值73%， 优化目标：>80%
    - 影响因素：纹理采样次数过多，纹理随机访问（如噪声图采样破环空间局部性）

- L1 Texture Miss% ：均值24%左右， 优化目标 < 15%
    - 访问的纹理次数过多，存放的纹理过大，需要频繁交换L1缓存等

- L2 Texture Miss% : 均值15%左右，优化目标 < 10%

- Kernel Load Cycles：25%左右， 优化目标：<20%
    - 影响因素：L1命中率低（72.7%）→ 数据供给延迟加剧核心饥饿

- **Write Total(Bytes/****sec****):峰值873M,均值650M+ yidong 600M**

- **Read Total(Bytes/****sec****):峰值1.89G，均值1.4G+ 移动端一般****读****每秒维持在1.2G**

- Texture Fetch Stall%: 14%左右, 优化目标：10%以下
    - 影响因素：纹理采样频繁或未压缩

- ALU/Vertex（顶点着色器ALU操作数）: 53左右, 优化范围：40以下
    - 影响因素：顶点数量、蒙皮骨骼数

- RenderTextureChanges: 12
    

**综上数据猜测：**

- **目前游戏读写每秒总带宽是2.7G左右， 说明带宽已经非常吃紧。**
    
- **通过L1缓存命中率更吃紧而非L2缓存命中率吃紧，应该能确认是渲染流程几何阶段和光栅化阶段时SM单元与L1缓存交互存在瓶颈，以及L1/L2之间的交互瓶颈, 猜测可能是以下问题导致**
    
    - 单帧内高频采样纹理
        
    - 着色器处理数据过多
        
    - 数据并行性不好，存在逻辑分支
        
    - uv采样命中率不高
        
    - 中间变量多和寄存器溢出数据
        
- **L2缓存命中率高了5%+说明DRAM主存与L2交互频率过高, 也有可能是L1需要频繁向L2获取纹素数据**
    
      
    

  

**针对家园场景，结合数据和带宽通用优化手段，大概推导问题原因**：

1. 减SetPass或者Drawcall（SetPass过多导致同帧内采样纹理次数过多）
    
2. 裁剪纹理尺寸(部分纹理尺寸过大)
    
3. 减同屏顶点（减少系统带宽，减少DRAM/L2间数据交换量）
    
4. 精简shader（shader计算复杂度，减少分支）
    
5. 减少纹理采样（L1 Texture Cache / TMU，直接减少访问次数）
    
6. 减少overdraw（减少在Tile Memory内部的无效像素操作 ）
    
7. GPU Instancing（减小CPU提交的指令数据量 ）
    

  

# 后续工作梳理, 确定大致方向：

### **投石问路**

1. #### **减少片元****着色器****纹理采样数量**
    
       当前建筑和家具都有日夜两张问题，都是在像素着色器里进行2张纹理的采样，测试方式是直接修改建筑和家具的shader， 改成只采样一张，然后再查看**L1 miss/L2 miss和读写****总带宽****数据**。
    
    ![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YzMwNWM0ZTU5Yjc0ZTA0YWM2M2ZkNTA5ODNlNDdiZTFfOGpHQklQUG5HdEtsS0pKbnZxVDNpelBKZ0hWQlhITVRfVG9rZW46VlBMTWJwMmFhb2d6Q2t4SXBaZWNzVmFWbk1kXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)
    
       L1 Hit%: 峰值77.46%，均值76%，提升不大
    
    ![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YzMyODRlN2QzNTk1MGI4NGQxMzNjMzM4NWZmYjNiNmZfVHh1bkFUSlFQTmZuOHN2ZDBOcUQ2OFl4UjZkNEJUanZfVG9rZW46Vk5KSmJQdGdEb1o3MFp4Mmt1UWNjaHljbkJlXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)
    
      每秒读写总带宽下降了200M左右
    
    ![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YTlmNDk0NGFiODU4ZmEzZDZhMzZhNDE4NmJiNTMxYTBfVEljSHF0bnRZNEZTY0pOMm83VDlrdmVISzl1VU9sanJfVG9rZW46SlJLU2J0NFhkb3pQRDh4U3JyYWN6Ym9kbnhiXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)
    
    ![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YzFkZGE4NmJhMGVmYzg0ZTNmMDRhNmIwMzFiZGZiMmVfaHljNEttZUF3V1dta3IwU2YweWNsekRmZE56UE5NUE1fVG9rZW46VmFQV2JoNUgwbzJsWHp4N0NFcGNYTGtZblZjXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)
    
      Kennel Load Cycles% 降低了1%
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MTI5Nzk2OTZhN2QwMDYyZTQzZGFkN2M4ZTc1NzEyOTBfeGtEMVJnMHdlcHgySGViVFUwTlJHYlhBWmdHbVZTQ2hfVG9rZW46S2JuamJMa1hrbzhxbDV4RFlFVmNHdDFwblhmXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

ALU/Vertex: 减低了2%-3%, ALU/Fragment提升了4-5%，主要是精简是建筑shader，去掉了一个黑夜纹理的采样

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YTcwNmE2ZWNhMTAyMGVjMzY5OGEwYzNjNTQ4ZDgwOTlfMmRVRnBDeFk2Mkp2OWpsWTJEZ2Rlemc1UHJtU3ZvY0ZfVG9rZW46T2hrSmJjWGxPbzJia1F4NDVyZWNRNWhEbjZpXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

L2 Texture miss率提高了3-4%， L1 miss率提升不大

2. #### **直接暴力减面**
    
       将建筑和家具的顶点直接减半或者25%，然后再查看数据**读写****总带宽****数据**，建筑shader恢复原样
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MGUyZDQxZDM3MGQ5OGQyMmFmN2UxMzc0N2VjOGM4NjhfZ3BOSnN0WjhacGg2NVlZSEF6NXNWMGd4emNMMHBWQ1JfVG9rZW46QXpJQ2JFTzNYb0lsRE14S3J5M2NZZUMybnBjXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

整体顶点数在暴力减面后从20w+降低到11w+，减面的百分比是50%

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=NTMzYzJjMDVmOTQ2MTNkZmRjZjUyNjlmYmNhYWJlOWVfNFlaQno1anp4VGsydFVRNjZWS2dQTTRHWFJ6cHBXWldfVG9rZW46S09pdmJ0aDF4b0JWcnR4SGl0RGNzQUxzbmloXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

L1 Hit% :峰值 78.27%， 均值76.5%，没啥提升

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjhhZGJjNDhjMzRiYzkxNDJmZmQxN2MzNTkyMzRkYzJfWjNLQzN4dTMwWm1JRmpmc0Zob3EyYjVESXhweXBVUWZfVG9rZW46R1pnNmJXYmVUb1RaWUt4eWl6WmNUOU1hbkNjXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

Kernel Load Cycles：峰值27.84%，均值已经接近20%， 优化目标：<20%

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=NjIwMjRiY2FmN2MzZTNhYmU0NDBhNzc3NTliM2Q2OTBfSW04Q3Q2RE52YndtRHBoajdVYU0yaGd6SUZWeGhrdHZfVG9rZW46TmVwemJXV0xrb3JvaGR4U3ZmdWN5ZkJrblk5XzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

ALU/Vertex和ALU/Fragment:变化不大，因为shader没修改

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=Njg4OTliZjBjMjExMGZhYWY2ZmZmZTMxYjRmNjI5YzdfZHVpdkR4QWZpd2dmNTdXVHdqVVFmS1ozNlhzZG1OOVZfVG9rZW46UVVoaWJ2SDZYb0tLRDB4S1p0R2NxUjhobkdmXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

每秒读写总带宽下降了300M左右

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YjM3N2JmNjJhZmY0NTY1ZmUyN2UwYTQyNmZhZDEwMDhfWUtEY01CSDFZNEg4aHlrSHR4QXdldXRTd1oxYXBaTG1fVG9rZW46S0ZGaWJoYkF2b0ZrM3d4UTN6dGNLWFRxbnJnXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

Texture Fetch Stall没啥变化

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=OGJiNmFkMzE4MmVjNWU4MmJhMWZmNzMyYTkwMjZjY2ZfejVNR0cwOHkyZ3lRM3dwaXhZUUdQT094QzVmTTkyQ3lfVG9rZW46TUoxUWJON0NIb1p3UEt4R2l2UWNZcWY1blpkXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

3. #### **综合暴力减面+shader优化**
    
      查看**总带宽****数据**。
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YTVhOGMwYjBlMWU1N2NjNmRhOWU0OWJmYTU1OTM3NDdfenNuaFg4QWJzaWQyV0hYSnpUOFBmSU1BOXFLSDFXSUhfVG9rZW46Sjk5SGJta0U5b2k0TlF4b3k5RWNJYWNybkJoXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

每秒读写总带宽跟测试之前相比**下降了500M左右**

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=N2VjODQyZTNiYTFiYjY1NWVkMGRmMWQwMTY5YmNmZDhfT3BIdE00SlFUVTZuUUpweU84a0w0QnVFdktYNHNMbDZfVG9rZW46UVVhVGJZdlBsb1JVTTd4bU5jWGNicTM0bkxoXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

L2 Texture Miss率跟测试之前相比下降5%，L1 Texture Miss一直没什么变化

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MTM5MDdkNTE5Y2IwMWY4NzMyMjZjNGUxYWM5M2NlOTdfRnI1dE02Rjk1N0RiSE1MTlBjTmtOU3dBYklXUWc4N0lfVG9rZW46RnhwUGJQVW5qbzVmYkF4dzI4M2N2dU9ObmZkXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

Vextex Fetch Stall% 下降了1%

  

8. ~~叠加批量暴力缩减建筑/家具/场景部件/~~~~NPC~~~~角色的纹理尺寸，然后再查看带宽数据L1 Cache Miss和Texture Fetch Stall（未做）~~
    
9. ~~直接各自不渲染家具或者建筑，查看读写~~~~总带宽~~~~数据/L1 Cache Miss和Texture Fetch Stall（未做）~~
    

  

### 测试结论

- 优化shader的采样纹理能优化L2缓存，减少读写总带宽；
    
- 优化同屏顶点总数，能间接优化Kernel Load Cycles，并且对总带宽优化友好，因为能够降低DRAM到L1/L2的数据传输量。
    

基于以上结论，家园针对这些结论会安排正式的后续的工作事项如下：

1. 建筑/家具/浮桥等模型做Mesh的LOD
    
2. 优化家园相关的shader，精简计算复杂度，减少纹理采样
    
3. 减少家园setPass
    
4. 低端机有选择的进行动态场景部件的精简。
    
5. 纹理尺寸裁剪
    
6. 纹理减少无用通道信息
    
7. 模型裁剪冗余信息
    
8. NPC的头顶血条和进度条进行Gpu instancing化（已实现）。
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YmI3ZGJlZDIzMTI4NmU1OGJjNzJmYjFmZmQ5YmQ0NjBfWUdrVVBVRGpBODFrckVwMEFrdmlUSnVZZVM3UkVTaldfVG9rZW46V002b2J2emk0b2NmVll4dEFnaGN5aUs3bjZnXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

### ToDo优化点

####   **Mesh无效数据批量处理（已处理）**。

  借助工具：[模型批量处理工具](https://o455xcugsp.feishu.cn/wiki/GqnOw3fTFiuhzPk3JOqcoe5Mnfe)

  优化幅度很有限，不贴数据了。

####   **纹理去掉无用通道（已处理家园的纹理）**

  借助工具：[纹理通道检测工具](https://o455xcugsp.feishu.cn/wiki/X8wVwDAEUikbuKkGy65cRKeFngh)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTg2Mjk5NTgwODlhYmQ0YjBkZWUyNzVjYTZjYzUxYTRfQzRPc2luMTk5c1dudjRVSkVoejhGeW5mSDgxQWxnTmxfVG9rZW46RFZpaWJ0T2R4b05RTzV4OERub2N6QldVblJkXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWFkMDdhODZiY2Q2NjM1ZTgzMWQ5YjU3MDJkODc4OTdfYXB6VVRMUm94MG1hQlR5QzJ5UFFSSTA5eTM1QzF4UnFfVG9rZW46UHRsM2JZRkhQb3VMQ0N4NVYyTWN6dGVRbm9nXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

处理完纹理尺寸在profiler里显示纹理内存相差4m左右，变化并不明显。

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=NzIzZjlhMTA4NmY1ZmE3NDIzZDVkNjllNzMxZTFlYjNfODYwNXA3d3BDdzd2TnZYd3gycXBBTEc3UHlIQWlHWmNfVG9rZW46QlJJdGJoc1dPb3pQQ1p4Rm1JeGNMWGtWbkJjXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=OWYwMmE1MzBlYjQ4MTBhZDk5MjIzNzQ2NTJlNTgyOThfZFR2RWJIcGlaQ0drdFJxa25Wdm5JZHVreWx0UEhabUlfVG9rZW46QzRPeWJySlNxb1pJSWl4azdNWWNxUUQzbjNjXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YTYyOGE4NTJkOWE1NGFhNGI4YmZkMzk5Njk3MTBkNDhfQ0ExcDZoczZTSG8zem5Za0prTFZ3OGI1eEljNjQ2NXRfVG9rZW46WnhnTWIxeHhNb0ZEZ1p4S2Nyc2NNcElwbm1kXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MTRkMzJiOWI2MzRlNjVkN2NmZGE4OWY2MmJjMDY3ZDJfUndKMDl0cWRtRUZ4NDlGcmxUaXR6RUVDNXBMWDNkRmpfVG9rZW46Tks3TmJWNm5Lb0hkNlV4SDl6OWNXTXVnbmlmXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

处理前后实际每秒总带宽相差不到100M，优化幅度有限。

  

#### 灯塔灯光特效和建筑浮沫效果裁剪（已处理）

  [家园测试灯塔和建筑泡沫特效的性能影响](https://o455xcugsp.feishu.cn/wiki/GB28wsvTGiPXgBk49Z7cXi9bnoN)

   处理办法：直接优化粒子的maxparticle属性，从1000改为30，以优化overdraw

  

####   **家园相关纹理尺寸优化（已处理）**

  借助mipmap调试预览工具：[Mipmap调试预览工具](https://o455xcugsp.feishu.cn/wiki/QrGww8L9DiI0sckW9M3cSSKqnpx)

1.通过mipmap调试预览工具缩减建筑和家具贴图尺寸（从512->256）

2.部分资源减少尺寸

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MzkyZGJkNTAwNTE5NmNjZmZjYTRiYWZhNzA0NWY3ZDNfSGxzVE5OVkN4OXZrSkF1b2FFVmVRcmtrZUppNkthTkxfVG9rZW46RkE5S2IxblY4b1Nma1h4VXp0cmMyT2pPbnBiXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

该次测试是叠加减少黑夜贴图采样+纹理去掉无用通道+纹理尺寸优化后的效果，没有加上模型顶点减半，相比最原始能减少500+M的每秒读写总带宽。

  

#### **家园SetPass或者Drawcall优化**

1. 家具shader修改为支持gpu instancing（已实现），所有家具材质勾选Enable Gpu Instancing，减少dc大概70左右 , 该处优化能减少了命令数据（Draw Call）和常量数据（每实例的Uniform）的提交量。
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=NmFiMjNlNDQ1ZjM0YzIwMDY3Mjg1MGE0ZmU4OTY5ZDdfVVVEV0dHZG04TFhOaERvMEFkYjVDblBhV1E0ajFyMjNfVG9rZW46VEc5SmJzTFozb2xsMlh4eXF5M2NFeUl3bktoXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=OWQ5ZGJkNzc0MTEwNWU0YmQyZThkMjU3YzRiZmRiZDhfM0MyZ0pTaGZITExCNGRtbk9ZNG5meFRnNDE3M1JDWklfVG9rZW46TFlONGJsZ0xxb1kwSVB4R3lyZ2M1MTFRbkRlXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTk1OGY5NzUxNzY4NWQzYzU0MTQ4OTU2MmExM2E1ZjZfNU4xUXhDcWNMdkc5ZmtHckt6TWVzNEh3TGs1QnVhTDNfVG9rZW46Q05hdWJtN1RYb1pkb2p4NU5IcGNOMGpDblVkXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

相比之前数据每秒读写总带宽又降低了100M左右

  

2. 家园围栏因为顶点超过300，不能合批，需要精简这些围栏（todo）
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGVmY2JiYzE4NGZmOTU1ZjljM2Y5MDdkZDJlYzFjNzVfWWdvSERJYzF6MDlUclpyZzd3dndqWXdWSDdkQmxMVk9fVG9rZW46WThWemJOY1c0b3NmUWF4dUxCQmNtUllCbjFnXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MTIwYjg0MmE5ZDlhMGQ2ZjMyOWM5MDA4ZDIwNjg5OGVfd3NkNXI4STc3cFltTHVoUFlrYm9yUGZWTHFJU0dmUHJfVG9rZW46TlhDTmJLSXh2b3QzWnV4WEMxamNFNmtTblViXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

3. 海底景观贴图目前都是单独的sprite, 没有合图集（性价比会低点）
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=ZThiMDY2ZWQ3MmU2OWE2Nzk4OGExMTA3ZTM4ODZiNDBfTkNET0F2VnYxRHRVMmJYcXBtNHRHNU5mcXA0RUlGa0pfVG9rZW46UVNKa2JNMGlmb2h0UXJ4QlJTZGNseUZybktUXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

4. 家具的阴影面片精简，通过lod来设置远距离不可见（已实现）
    
      优化幅度比较小，就不贴数据了。
    
5. 建筑的窗户双sprite，后续美术做成子mesh合入建筑mesh中（美术施工）
    

  

6. 设置家具/窗户/浮桥的sortlayer, drawcall减少80~90左右（已实现）
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWYwOGVmMmU4N2JkODI5NTkzY2RjZTFkMTA4NmQwZDdfUjZTZ1lXaVBNS2NDSTVTU3JCZnRFaXh2RmFHMk5XYmFfVG9rZW46Rnd0WGJHcnJlb0FiME54VVk4NWNWaExEbjZkXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=NzAwNTc5ZmFmYjZlNTYwNWRjYjZkYTlmYjlmZjU5MGRfVUw3dEdlUmhnWDRINUxySkVwbDd0elMyZmZ5NHZnYUpfVG9rZW46UUpQTGJEdGFVb0tOUTF4Y0JZWGNCQ0tTbm1jXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YzYyNTkxOGY5YjVjY2NkZjU0N2MyNjE5YzQ2MTJjZDJfalZNTXIwRFgwaW9xSnpOMnlET095VWcwb3lLOWxUVzdfVG9rZW46RU1waGJ1dGtZbzBGQnd4SHMyRGNYS2ZSblZlXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

整体每秒读写总带宽变化优化不到50M，因为完善的是半透物体的渲染顺序，对带宽的优化不大。

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=OWEwYmZjNDgwYzczOWFiYzFmYzhjZDEzYmFiZjg1NDNfem02OEpJbXRLT0VDQlFGOVFIOG1haTBhc3VXT3NNSTFfVG9rZW46TkVlNGJ5RTZob0JyZjl4am5Nb2NlSERVblJoXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

7. 泡沫特效dc，数量非常多，已换成mesh实现，通过降低泡沫mesh的顶点来能达成动态合批条件，能降低Drawcall数量20+个
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MGYwMDNhZWI3MTA5MTk0MGZkY2M1YzM1YjcwNjc5ZDlfaU1XbERORnhtZldoV2lnd0R2UndVdDZjS2NRWWVBc2xfVG9rZW46VVVzTmIwcjdFbzNwZWt4WXBQbGMwUkhPbjJnXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=N2ExY2FjODNhMDMyNzllMDU2ZWFhNzJmZDg1ZmVlYTlfYXp6eXdrS20zOGRyeUM4ZmR2ZjVoMldoRURKTmxyV1hfVG9rZW46UmQ3NWJCbkQyb0JUS214bVpFOGNBOUJHbjdlXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

RenderDoc下截帧，泡沫特效（2个particlesystem）一共28个drawcall， 耗时2.4ms

  

  

  

  

#### 特效优化

1. 鱼群特效**ef_home_underwater_fish**，粒子的render模块的排序（Sorting Mode）设置为By Depth (Painter's Algorithm)，需要关闭，并且鱼群特效有个02节点粒子开了
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YzViZDI1MTZmNzk2YzZmY2MwYjAyNjVmNDg2OGE2ZmVfeWxiQWRTUmgwNjhmTktQTkRWV1Qya2s5blR5am1UR3hfVG9rZW46VnF5NWJ0SFlNbzBqbnd4bmxjR2N4MkRpbk5oXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

并且所依赖的子节点的maxParticle为1000

  

#### SDP截帧细查

1. 还存在部分建筑海浪泡沫特效还存在多余drawcall，原因是建筑海浪泡沫优化时遗漏掉几个，还是用particlesysytem实现的
    

解决办法：将这些遗漏的drawcall所在的建筑预制件继续进行修改，改为Mesh实现(已实现)。

2. 发现不透明渲染队列中有一个gldrawElements（类似于unity中dc的概念）的每帧带宽消耗很高，原因应该是该渲染元素是海底底色，不透明overdraw是全屏的。
    
      解决办法：该节点直接隐藏掉，可节省2.3M+每帧。
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YWVjNjQxNjBmODdhMTY2MjdlNTg1ZDM4MDU0NGU5OGNfcVQyZ0I4c0Z4eHJYSkNhQm8xWnpiUEJxTk9Hd2NRUEZfVG9rZW46QTMyZGJhRTc5b3E5WlR4Ymd5M2NDTTVQbmJ5XzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

3. 海水的renderPass的写带宽消耗非常高
    

解决思路：需要进一步看下海水这里的实现

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MmUyNTczOTIxNDczMTQ0NDA4ZjliMDAwYjEzOTFjOWFfZmNlc21hRERSS0hDeXlYSHhQNU5uUU5TYUw1akpWbWdfVG9rZW46WUZROGJiN2dtb29Cd014SFd2RGNMR1VVbmliXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

4. Present.BlitToCurrentFB的消耗特别高
    

原理：https://www.yuque.com/yichuixigua/yc6gzd/elt7rgpbhtxhg2sc?singleDoc# 《snapdragon profiler 家园截帧数据分析》

尝试将BlitType改为Never, 可以减少一次Blit

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDI3YTBiYmVlNmIwODVhYzI0MDMzMjAxYWExZmFlMjhfcVRESFdRbU1ham5nUmJkWjVuMXVaWnExZk5xVVNHM2NfVG9rZW46QU9EbWJib0FYbzZCMXl4WFUxN2NpRDR3blNoXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

  

### 优化前后对比：

#### 温度（小米Mix2）

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=NzM2MmY5ZjQzOGY3ZTYzZTJlZTc3MDFjY2I0YTcwZjRfdlpMY09aMHdlS1dQV0lmR0dCa2dSNjFIM2tMNjB5R3pfVG9rZW46SnFWUGJ0cVRtb3dtM1V4UjdQd2NxcGJUblFiXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=ODEwY2U1ZmFjNjA3YmVhYWJiZWVmZmI1OWM5MWFhYjFfOWNUaktLUnpLOXRSeTc4UjY2ZTE5NGZHQjlraEk5NjhfVG9rZW46TVVEamJBakJ5b2NkMzd4WnQ3VWMwV1BSblJnXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

#### 帧率（Redmi 9A）

优化前：

默认视角下：16-18fps

测试视角下：20fps

最远视角下：20fps

优化后：

默认视角下：18-20fps

测试视角下：22-24fps

最远视角下：23fps

#### 带宽

家园纹理尺寸缩减+减少shader采样纹理数量+纹理去除无用通道+dc优化+家园粒子overdraw优化后，带宽的每秒读取大小从**1.88G减到1.35G**，每秒写入大小从**0.87G减到0.73G**，距离目标的**读取大小1.2G和写大小0.6G**还剩**200M**左右，这需要后续美术的**家园建筑/家具/浮桥等模型的减面操作**和**drawcall优化**来达成目标。

  

  

### 8月27号TA优化shader采样结果

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmMyZjg5MzBlOTc0NWZlOGVkOTU1NjkyNzlkNTI3MDRfaGVOWFJjemZBdzAyREpHcjlzd1hUQ0pwNXRhMDQ1RjZfVG9rZW46TjF4eWJIZUVNb2tsVk54YUd4RWNtZFNibjllXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MDkzYzU4ZTE4YjhjNjE2NzRhYWEwZjhhYjJmMWJiMDVfYUdYS3RwR1FzSjBjeUI1RFViZ1R1QldUNVBBcTBPVmZfVG9rZW46RDJEdGJKWGM4bzNwdzF4MGJXemNFZWlrblhiXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=NzU2ZGJiNTFhYmY5YTY0NjQ2ZDRmOTEzZjQ5MmFmM2VfV00zbjNrU0Zac1BsVjNSd0xUY3k0dlhHNFZrZktFN3hfVG9rZW46TDNJTmJzTWZ0b0c1TXJ4Znc5SGNxOXE5bnBkXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

优化前：写带宽0.804G，读带宽1.6G，纹理占用内存93.6M

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YmY2OTRmMDA1N2I0YTMwMGUwZjc4OGUxNmQ4NzZiZjFfUkpsaWlsR0ZJWk9MT3VUa2dia3dRRXdCb3puWGV1WnlfVG9rZW46RXlsZWJVSWl1b1dLbHh4bzdaMmN1V3FpbmZoXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTlhZmFlNTg3MWVhMjRmMzMzNWYzMjRmZmFlNWZmYjlfMFNVNHhseDVSTE5HV3F1MHFsNU5LOFFzYXVGUUY0SlZfVG9rZW46VElpb2Jnendyb3RpWFR4QUM3YmNVRVJlbkplXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MGNhMTg2MzUxZGEzOTdlY2VkY2VjOTMyNTcwYzlkNTFfc1JSbDd6U2hEbWZORXlSd0g3NjhLS1NyVTBGMWl3MUxfVG9rZW46TUloT2JBeDY2b2htYXZ4d0RJNmNXMDJ5bmg5XzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

优化后：写带宽0.77G, 读带宽1.488G，纹理占用内存87.8M

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=NTliMTQ0MmJjMjQ5NDk5ZGY1MzhlNTVlNWQ3MmYwZjVfVFhQYjdFMXRHQnhac0pxbmk2OXVOdDZZMjFVSzliOENfVG9rZW46UGZZbGJuUFp6b3lscWN4ajRMUWNlWmlhbmdiXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

测试视角：

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=N2UyZDU3NmM5NDk0NmViZDk3ZWY5MTlhZTFlN2IwNTJfZTBmTENNczdmSWdpNVhySTJQWHRiZTNPTXA5ZUdQUWJfVG9rZW46V29OOWJIYVVsbzA0MmN4N2Vta2NtdkhHbjJnXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

  

  

9月11日家园数据

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MDZkYWRmM2Y1YTY4OTJiOTQyNzAwZTg5NjA2MzBkYWJfSGt5WGVzemwxY1dzalQ3RzlLMXBFbG52UUVSU2ROZFRfVG9rZW46V3REZWJYWnFXb2hQb2x4dHY3YmM5M2xLbmdlXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

9月16日家园数据

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MDQ4ZTdmYWZkZDJmZmRlYjg2N2ViNDg5MzQxYmY4ODZfNGN0MVdkeWpLSUduSUsxWW9URDJoNGhBbXcyWGVZUHFfVG9rZW46WFJ2UmJCQW5Nb1JrNGF4MGpaaWM1M3l3bjllXzE3NzAxODg5OTk6MTc3MDE5MjU5OV9WNA)

  

Todo:

RenderDoc下查看每帧的纹理采样有哪些