## 一、背景

###   **1、Unity的Text主流的有两个**：

- Text
    
- **TextMeshPro（**下文一律采用TMP说明**）**（社区插件，好用集成到unity）
    

###     **2、对比**

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2FhYWJhNmE0ZWNhM2I3MGFhNzQxZmM4Y2FiMWY0MDVfdklSWVZqb21EcHpUbE9iNHp1YTlwRHFIS2p0TlBOVXZfVG9rZW46WDNyeWJjMzJpbzZOU0J4VDl0cmNxWWRPblJnXzE3NzAxODg5MTI6MTc3MDE5MjUxMl9WNA)

基于相关的原因，现在项目基本都是使用TMP；由于TMP在做中大型项目的时候，会遇到很多问题，可能不同阶段暴露的都不一样；

为了后续大家在遇到TMP问题的时候，可以准确、高效定位、解决问题，列举10个问题来和大家进行分享；

## 二、项目使用问题

###   1、字体、字符、字形、unicode是什么？

  可以通过该软件来看一下：https://www.high-logic.com/zh/font-editor/fontcreator

  根据字体，看以下几个内容：

- 字符
    
- 字形
    
- unicode
    

###   2、TMP文字是如何显示出来的？

  **内置部分**：

    step1: 加载TMP_Settings,自定义相关配置（需要手动加载）

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDAzYWE0Y2FlM2UzYmUwOWM3ZWQzY2VhNGViMzgyYTVfYXRlb2FRVVN2cXVUSGFieGJMeW1uRUlzSWRKcGZ1UUtfVG9rZW46TTZlbWJhWlQ4b2x4WUF4OVNWTWNZRjRYbmZ1XzE3NzAxODg5MTI6MTc3MDE5MjUxMl9WNA)

    step2： FontEngine.InitializeFontEngine();

    step3： FontEngine.LoadFontFace()，加载对应字体

     **显示部分**：

    step1：TMP.text触发数据刷新(动态)，也包括OnEnable启用触发静态文本

    step2：遍历TMP.text字符、转换为unicode；（以下步骤会有缓存行为）

    step3、根据上文unicode，获取字形index:FontEngine.TryGetGlyphIndex()

    step4、根据上文glyphIndex 获取字形Glyph：FontEngine.TryGetGlyphWithIndexValue

    step5、这里需要区分dynamic、static字体：

      Dynamic:

        step1、动态图集是否可以容纳对应字符（size、index），FontEngine.TryAddGlyphsToTexture

        step2、加入ok，缓存相关数据；失败以默认字符代替

        Static:

        step1、直接缓存字形、字形index，unicode相关参数

        step6、根据上文准备的相关参数，创建或者刷新对应mesh、从图集中获取相关字符信息，赋值给mesh；这里需要区分一下UI/3D渲染（CanvasRender、MeshRender);

        step7、相关mesh准备好，交互给Render，执行相关渲染，即可看到；

  

###   **3、TMP 静态字体、动态字体是什么？**

  1、**静态字体**，表示在游戏运行之前，就已经把相关字符的数据已经打包存储到对应的material、atlas上了；相关的操作方法：

  实际项目演示（创建、更新）

  2、**动态字体**，表示在游戏运行过程中进行查找、创建，游戏结束后自行释放：

  实际项目演示（创建、更新）

  

###   4、TMP动态字体是否会导致内存溢出？

  静态字体已经提前打包，那么动态字体是否会导致内存溢出；可能会在临界点导致内存溢出；但项目里面已经做了相关处理，如动态图集数量限制；（项目内说明）

  

###   5、TMP显示字符缺失问题？

  1、检测字体是否包含对应字符

    如果是：Alibaba PuHuiTi 2.0字体缺失，需要执行改文档相关操作，把字符添加到字体中去；[字体缺失补充工具](https://o455xcugsp.feishu.cn/wiki/Px05wQegIiNsnsk5VvGc05Aanne)；如果该字体确实不支持，那也就是不支持；

  2、检测字体是dynamic、static

  **Static:**

    如果字体支持对应字符，需要把对应字符填充到对应的程序集里面即可(**实际操作说明**)；如果不支持，那缺失是正常的；

    **Dynamic:**

    如果字体支持对应字符，那么需要检测以下问题：

- 是否图集数量到达上限，该限制内存无限暴涨问题；
    

  

###   6、TMP资源占用内存如何优化？

  **普通情况**：

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=NmE2ZGMzOWQxZDYwNzA0NWI4NTkwOGEyZjQzNjc5YTVfNFlpNTlvZmdUQ3FSWGxDVUtkcXJkQXhKQUNmemlSRFNfVG9rZW46TVo5M2J0MWlHbzNYMVR4N2FrcWNBdWo1bk5kXzE3NzAxODg5MTI6MTc3MDE5MjUxMl9WNA)

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MjBjNzY2OTYwMTEwNDhiMjY5OTU4MmUwOTUyMTZlMWZfcDhMUm1GVGFXWEhvVWg3RVUwbTRPQXdSWWQ3bkMzV1pfVG9rZW46VkZETGJyM0Fxb0VDTDN4bG1RemN2ajRJbnVjXzE3NzAxODg5MTI6MTc3MDE5MjUxMl9WNA)

  第一张图片是正常static字体的生成情况；其中Normal-Extra-1/2都是8.3M左右；

  第二张图片可以看到只有2.5M左右，图片大小和内存大小都会有所提升；

  **原因**：

  1、默认生成方式，赋值给字体mat的参数是*.asset，其中包括图集、字符相关数据，由于字符多，相关数据也多；然而我们只是需要他的Texture，用来赋值给material；其它数据都是运行时无效；

  **解决方案**：

  生成Alpha8的Texture，直接赋值给相关引用Material即可；

  **字体源优化：**

  CJK(中、日、韩)的字符数据是最多的，尤其是中文，但是常用的中文3500+，日文部分用的中文，所以从源头上移除生僻字；对字体进行拆分，直接源头减少内存（实际说明），优化幅度大；

  

###   **7、TMP下为什么会有SubMeshUI这样的节点？会带来什么问题？**

  在TMP下会看到TMP SubMesh开头的这些子节点，这些子节点在以下两种情况会出现：

- 在TMP中的字符源来源于不同的字体，也就是是不同的材质，那么就会进行创建；
    
- TMP SubMesh的创建流程是动态创建GameObject对象，添加相关组件，比较复杂；部分代码如下图：
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YjQ4NzRlYzQ3YzI5MWFlOGEzNjhmYTRjMGZjNWNjY2VfalluUDFLano0WWJlQnozNEVPZ3VoTEhtNjhYbVdERHhfVG9rZW46TFRsSGJiNkxpbzh1dE54RWJPNWNQV0txbnlkXzE3NzAxODg5MTI6MTc3MDE5MjUxMl9WNA)

  默认TMP_SubMeshUI子节点分配为8；会根据实际长度进行动态扩展；

  高频出现的情况：

- UI效果采用中文
    
- 实际游戏采用英文
    
- 中文和英文采用不同的字体或相同字体不同mat（扩展）
    

  这样就会出现节点创建问题；该类问题需要区别对待，比如海外游戏用英文效果，国内用中文效果制作；当然该问题一般不是性能瓶颈，只是有优化空间；

  

###   8、世界聊天多语言是如何适配显示出来的？

  基于以上说明，在世界聊天的多语言环境下，是如何做到各输入语言自动适配到各自的字符的？这里就是TMP的核心之一:Fallback（结合项目说明），同shader一样；

  需要注意以下问题：

- Fallback设置成递归状态
    
- Fallback设置的先后顺序
    
- 项目默认Font
    

  同时说明一下加粗的情况；

###   9、在热更期间是否可以修改字体？会带来什么问题？

  字体的修改会导致相关直接引用的变更，增加热更大小；基于此一般情况下字体不会轻易改动；

- 静态字体不允许在热更期间随便改动（强烈要求除外）
    
- 动态字体无更改需要，只会存在字体字符补充的情况，一般也只是在大版本；
    

  

###   10、游戏中多种字体如何调节美术想要的效果？

  项目中的字体有8种左右，支持的语言有18种左右，没法通过一种参数达到视觉效果的统一；如下图：

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=OWYwZjlmNjllNGQyOWQzMjZjNTJiNGM1ZWI2MGJmMDdfY1QyeEc1V0owSmhVeDFLTjY3M3FyRVFadzZxNGNOYTdfVG9rZW46WkNZY2JHaUQzb3NLNnd4VW56bmNxY0JXbnRkXzE3NzAxODg5MTI6MTc3MDE5MjUxMl9WNA)

  前期只能根据项目主流区域用户、语言调整合适的效果；也就是项目中的主要字体效果达到视觉标准，如果整个项目只用一个字体，那就不会有这些问题（理想情况）；

  效果的增加文档：[Font 新增效果](https://o455xcugsp.feishu.cn/docx/M0sodotFDoH9v2xnVflcEvgQnYd?from=message&source_type=message)

  效果参数调节说明：[项目字体使用说明](https://o455xcugsp.feishu.cn/sheets/IltYs9ogTh9h5ntIZMEcU5KKnSF?sheet=lJXRQ6)