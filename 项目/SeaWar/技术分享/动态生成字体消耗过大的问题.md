---
tags:
  - SeaWar/Unity/TMP_Font
---
# 一、背景

修改了字体SDF文件大小后，很多字体缺失了依赖动态生成，在排查其他问题的时候，发现这里动态生成5个字符就花费了34ms，这个消耗是很大的![[（图解3）耗时字体来源.jpeg]]![[（图解1）字体加载耗时.png|680]]
# 二、定位原因

## 1. 添加log

因为在profiler中无法查看是哪个字符消耗，所以增加了log定位![[（图解2）添加字体加载耗时日志.jpeg|700]]

发现是 土、编、齐、造、约 这几个字动态生成了
![[（图解3）耗时字体来源.jpeg|290]]

## 2. 对比之前版本

对比了10天前的版本（未做优化的版本）![[（图解4）旧版本耗时.jpeg]]
![[（图解5）旧版本耗时1.jpeg]]
![[（图解6）旧版本耗时2.jpeg]]

发现虽然也有，但是消耗不大

## 3. 对比变动

对比了一下变动，发现新的字体也没有太大的改变，应该不是这一块引起的，所以先略过这一块

## 4. 深入研究

看 FontEngine.GetOpenTypeFontFeatures 上一个，调用 FontEngine.GetLigatureSubstitutionRecords，翻译一下就是 **获取连字替换记录**
![[（图解7）连字替换耗时.jpg]]

首先得知道什么是**连字**

连字就是在特定组合的时候，会改变自行，让其看起来更舒服（中文中一般没有这种操作）
![[（图解8）连字.jpeg]]

参考：[https://foGetLigatureSubstitutionRecordsnts.google.com/knowledge/glossary/ligature](https://fonts.google.com/knowledge/glossary/ligature)
同时我们也可以看到在阿里巴巴字体中确实存在连字的信息，但是很少，而且是英文
![[（图解9）阿里巴巴字体中的连字.png]]

所以我们大概知道是和这个有关系了

# 三、动态生成字体流程
![[（图解10）字体生成流程.jpeg|660]]

SDF生成字体会依赖 TTF/OTF 源字体，只有原始文件中有对应的文字，才会生成出来，不然就会变成默认文字例如 口口口口口

TTF/OTF 除了存储 unicode -> 文字 的信息，还会存在一些额外的信息，成为 **FontFeature**

# 四、FontFeature

![[（图解11）项目中的FontFeature.jpeg]]

SDF中记录的信息可以在编辑器中看到

上半部分就是unicode对应字符形状相关的数据

下班部分主要有4块

- **Ligature Table** (连字)
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MmYzMWIxMGRmNjAwNTUzMThiOWY1NWMyMmE2NzZlOTRfMEJkR3VFU1A1Q2ZvYkNIUmZVVktQOTNpa0NOTUJEamlfVG9rZW46RmVPeWJnUUM3b3Z0UnB4dkNDTWM5Z3VxblJlXzE3NzAxODg4ODM6MTc3MDE5MjQ4M19WNA)

- **Glyph Adjustment Table** (字间距)
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YzAyYjg2NDlhNjk5NGQyMDFiMTBkZTkyYjE0NmI1ZGRfczlzRFNHQTBWR2pWNmYzbFpaVnNDVndMVWRmZ2hyRFNfVG9rZW46RnlGQmJiUlQyb3dIcHJ4ZTJmT2NRTGpibjVjXzE3NzAxODg4ODM6MTc3MDE5MjQ4M19WNA)

- **MarkToBaseAdjustmentTable & MarkToMarkAdjustmentTable** (附标)
    

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YmY5NzVkMzA4MmMwMmI0Mjc2ODgxYWJkNjAxMTJjNDBfbm1XYVREZWxjTnczOE04STQ5cGtBTVY5RzY1RGVURFlfVG9rZW46UXZwNWJWU3Iyb29wRGt4VjJjdGNnWHRvblpLXzE3NzAxODg4ODM6MTc3MDE5MjQ4M19WNA)

  

这些东西在汉字中都用不到，而且我们也不会使用Alibaba字体动态去生成数字、字母、标点这些，所以里面存的信息我们都用不到，在动态生成字体的时候我们就不需要这个东西了。

# 五、对比测试

在SDF中关闭GetFontFeatures，这样在动态创建字体时不会去读取字体特性了

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=NGE1NWE5MGYxMzcxZjZmYjI0M2NmNmVhMGIyYjQ3ZTBfb21mdG9sbnpiRVQzYmZhamRRYmpzbjhWWjBFTmJzbE5fVG9rZW46TW9DU2JXOEFkb2pkdW54U1dZZ2NtZ0ZCblVjXzE3NzAxODg4ODM6MTc3MDE5MjQ4M19WNA)

**勾选消耗**

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=YTc0OTY2NTFmMWUwN2RlOTMyMjU5ODgxMjhjYWIzODBfdFZGQ1FGNzdEMEFQU2NEdUhrUWFnajJ3Zzg1N0JaM3dfVG9rZW46S3JZUmJNa0dGb2xLQUd4eEhXRGNwbnZrbmZlXzE3NzAxODg4ODM6MTc3MDE5MjQ4M19WNA)

**未勾选消耗**

![](https://o455xcugsp.feishu.cn/space/api/box/stream/download/asynccode/?code=MGNjMzA0Yjg4MDY1N2ZiOTE1MDk0NTVkZGRmYzNkOGRfU2xQbGJNMnptenRnZVdGNDZWMms4dTBxVm5BZDNBZUNfVG9rZW46RTlVZmJOSnEzb2I4Zk94WUs4bWNRMXRIbm1jXzE3NzAxODg4ODM6MTc3MDE5MjQ4M19WNA)

## 数据对比

|   |   |   |
|---|---|---|
||勾选ms|未勾选ms|
|第一次|7.7|1.11|
|第二次|7.82|1.19|
|第三次|7.64|1.2|
|平均|7.72|1.17|

# 六、修改方案

- 在中文 SDF 动态生成字体中取消勾选 GetFontFeatures
    
- 其他语言的我们目前不好拿捏效果，先保持勾选