---
tags:
  - SeaWar/更新/APK差分合并
---
# 1. ApkPatch 工作原理

## 1.1 核心操作
整个ApkPatch一共有三大核心操作：Normalized、Diff 和 Patch

### 1.1.1 Normalized 操作

**目的**

为了让 Diff/Patch 过程**兼容 APK 的 V2/V3 签名**。确保 APK 中的压缩数据可以被 zlib 以固定参数完全复现。

**原理**

从源码 `apk_normalized.cpp` 和 `normalized.cpp` 分析，Normalized 执行以下操作：

1. **重新压缩所有文件**：使用固定的 zlib 压缩参数（默认 level=6）重新压缩所有 deflate 数据
2. **对齐文件偏移**：对未压缩文件做字节对齐（类似 zipalign），优化运行时性能
3. **移除 V2/V3 签名块**：APK Signing Block 会被删除（V1 签名保留）
4. **规范化 ZIP 结构**：移除 Data Descriptor、规范化 Extra 字段、保留 Comment

```cpp
// 源码位置：src/apk_normalized.cpp 第29-33行
// apk_normalized是为了diff/patch过程兼容apk的v2版签名而提供;
// 该过程对zip包进行规范化处理:
//   输入包文件,重新按固定压缩算法生成对齐的新包文件
//   (apk的v2签名数据会被删除)
//   规范化后可以用Android签名工具对输出的apk文件执行v2签名
```

**为什么需要 Normalized**

| 问题 | 说明 |
|------|------|
| 不同 zlib 版本压缩结果不同 | 同样的数据，不同版本/参数的 zlib 压缩后字节流不同 |
| V2/V3 签名覆盖整个 APK | 签名校验的是压缩后的字节流，不是解压后的内容 |
| Patch 需要重建压缩数据 | ZipPatch 用 zlib 重新压缩，必须与原始字节一致 |

**如果不做 Normalized**：
- Patch 重建的新 APK 压缩数据与原始不同
- V2/V3 签名校验失败
- APK 无法安装

### 1.1.2 Diff 操作

**目的**

生成旧 APK 到新 APK 的差分补丁文件（patch），体积远小于完整新 APK。

**原理**

从源码 `Differ.cpp` 和 `DiffData.cpp` 分析，Diff 执行以下步骤：

1. **解析 ZIP 结构**：读取新旧 APK 的 Central Directory，获取所有文件条目
2. **自动检测 Normalized 状态**：
   ```cpp
   // 源码位置：src/diff/Differ.cpp 第152-169行
   // 检测新 APK 的压缩数据是否可以用固定 zlib 参数复现
   newCompressedDataIsNormalized = getCompressedIsNormalized(&newZip, ...);
   // 如果新 APK 是 normalized，检测旧 APK 是否也用相同参数
   if (newCompressedDataIsNormalized && UnZipper_isHaveApkV2Sign(&oldZip))
       oldZip._isDataNormalized = getCompressedIsNormalizedBy(&oldZip, ...);
   ```
3. **文件匹配**：通过 CRC32 和文件名匹配新旧 APK 中相同的文件
4. **生成差分数据**：对变化的文件使用 HDiffPatch 算法生成二进制差分
5. **记录元信息**：将 `oldZipIsDataNormalized`、`oldCrc`、`oldZipCESize` 等写入 patch 文件

**Patch 文件结构**（从 `ZipDiffData.cpp` 分析）：
```
+---------------------------+
| 压缩类型标识               |
| Normalized 状态标志        |  ← oldZipIsDataNormalized
| 旧 APK 的 CE 大小          |  ← 用于校验旧 APK
| 旧 APK 的 CRC 校验值       |  ← 用于校验旧 APK
| 相同文件对列表             |
| 差分数据（HDiffPatch）     |
+---------------------------+
```

### 1.1.3 Patch 操作

**目的**

在客户端设备上，使用旧 APK + Patch 文件，**字节级还原**出新 APK。

**原理**

从源码 `Patcher.cpp` 分析，Patch 执行以下步骤：

1. **读取 Patch 元信息**：解析压缩类型、Normalized 状态等
2. **校验旧 APK**：
   ```cpp
   // 源码位置：src/patch/Patcher.cpp 第113行、119行、154行
   // 校验 Central Directory 大小
   check(zipDiffData.oldZipCESize == UnZipper_CESize(&oldZip), PATCH_OLDDATA_ERROR);
   // 校验 CRC（包含 CE 数据和所有引用文件的 CRC32）
   check(zipDiffData.oldCrc == OldStream_getOldCrc(...), PATCH_OLDDATA_ERROR);
   // 校验数据流大小
   check(oldStream.stream->streamSize == diffInfo.oldDataSize, PATCH_OLDDATA_ERROR);
   ```
3. **解压旧 APK 引用数据**：将需要的旧文件解压到内存或临时文件
4. **应用 HDiffPatch 差分**：还原变化的文件内容
5. **重建 ZIP 结构**：按原顺序写入 entry，保持 offset 和 alignment
6. **重新压缩**：使用与 Normalized 相同的 zlib 参数压缩数据
---
# 2. 生产环境 APK 差分更新流程

## 2.1 APK 构建流程（CI/CD）
```
┌─────────────────────────────────────────────────────────────────────────┐
│                           CI/CD构建服务                                 │
├─────────────────────────────────────────────────────────────────────────┤
│  Unity/Gradle 构建                                                      │
│       ↓                                                                 │
│  app-unsigned.apk                                                       │
│       ↓                                                                 │
│  ApkNormalized ──→ app-normalized.apk （压缩数据规范化，V2签名被删除）   │
│       ↓                                                                 │
│  apksigner ──→ app-release.apk （重新签名 V1+V2+V3，发布给用户）         │
└─────────────────────────────────────────────────────────────────────────┘
```

**为什么 Unity 直出 APK 后还要重新签名？**

| 步骤            | 说明                        |
| ------------- | ------------------------- |
| Unity 构建      | 输出已签名 APK，但压缩数据未规范化       |
| ApkNormalized | 规范化压缩数据，**但会删除 V2/V3 签名** |
| apksigner     | 用相同 keystore 重新签名，确保签名有效  |

## 2.2 Patch 生成流程（服务端）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         版本服务端（Patch 生成）                         │
├─────────────────────────────────────────────────────────────────────────┤
│  old-release.apk (线上旧版本，已 Normalized + 已签名)                    │
│  new-release.apk (新版本，已 Normalized + 已签名)                        │
│       ↓                                                                 │
│  ZipDiff ──→ update.patch （自动检测 Normalized 状态，写入 patch）       │
│       ↓                                                                 │
│  ZipPatch 验证 ──→ 确认 patch 有效                                       │
└─────────────────────────────────────────────────────────────────────────┘
```

### ⚠️ 常见错误：不要对已签名 APK 再次 Normalized

```python
# ❌ 错误做法（你之前的脚本）
tools.normalize(old_apk, old_norm)  # 会删除 V2 签名！
tools.normalize(new_apk, new_norm)
tools.diff(old_norm, new_norm, patch)  # Patch 基于无签名的临时文件
# 客户端用的是有签名的原始 APK → PATCH_OLDDATA_ERROR

# ✅ 正确做法
# old_apk 和 new_apk 已经是 Normalized + 签名的最终发布版本
tools.diff(old_apk, new_apk, patch)  # 直接 Diff
```

## 2.3 客户端 APK 更新流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              客户端                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  old-release.apk (设备上已安装的 APK，通过 sourceDir 读取)               │
│  update.patch (从服务器下载)                                             │
│       ↓                                                                 │
│  ZipPatch/ApkPatch ──→ new.apk （字节级等于 new-release.apk）            │
│       ↓                                                                 │
│  安装 new.apk （V2/V3 签名校验通过）                                      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 客户端错误码处理

| 错误码 | 含义 | 处理建议 |
|--------|------|----------|
| PATCH_SUCCESS (0) | 成功 | 继续安装 |
| PATCH_OLDDATA_ERROR (10) | 旧 APK 不匹配 | 检查版本对应，回退全量 |
| PATCH_OPENREAD_ERROR (1) | 文件读取失败 | 检查权限和路径 |
| PATCH_MEM_ERROR (4) | 内存不足 | 清理内存或使用临时文件 |
| PATCH_HPATCH_ERROR (5) | 差分数据损坏 | 重新下载 patch |

---

# 3. APK 字节级黑名单（V2/V3 签名必死项）

> 以下行为 **只要出现一次，签名必定失效**。

## 3.1 绝对禁止的操作

- ❌ zipalign
- ❌ 重新压缩 APK
- ❌ 解压再打包
- ❌ 修改 ZIP entry 顺序
- ❌ 修改任何一个字节

## 3.2 隐性踩雷点

| 行为 | 说明 |
|------|------|
| 使用 FileOutputStream 重写 APK | 会改变 zip 结构 |
| Unity 二次拷贝 APK | 部分 ROM 会重写 header |
| 使用第三方文件管理器 | 可能触发文件系统重排 |
| Debug 构建验证 Release patch | 字节不同 |

---

# 4. 生产环境 Top 10 失败原因

1. **使用了 split APK** - Google Play 动态分发
2. **ABI 不一致** - Unity 导出与 .so 不匹配
3. **apk_patch.cpp 被修改** - 破坏了算法逻辑
4. **zipalign 被额外执行** - 某些构建工具自动执行
5. **patch 与 old.apk 不匹配** - 版本对应错误
6. **Debug / Release 构建不一致** - 字节级差异
7. **Unity Gradle 覆盖 so** - 配置问题
8. **下载 patch 未校验 hash** - 下载不完整
9. **ROM 文件系统权限问题** - 部分国产 ROM
10. **多进程并发 patch** - 文件锁冲突

---

# 5. 常见错误速查表

| 问题 | 是否影响 so | 说明 |
|------|------------|------|
| applicationId 不一致 | ❌ 不影响 | so 与包名无关 |
| JNI 类名不一致 | ✅ 致命 | 找不到 native 方法 |
| compileSdk 过低 | ❌ 不影响 | 仅影响 Java 层 |
| minSdk < 21 | ⚠️ 风险 | 老系统不建议 |
| targetSdk 提升 | ❌ 不影响 | 运行时行为不变 |
| 未链接 android 库 | ⚠️ 可能链接失败 | `AAssetManager` 未定义 |
| 未开启大文件支持 | ⚠️ 潜在编译错误 | `off64_t` 相关问题 |
| ABI 不一致 | ✅ 运行时崩溃 | `UnsatisfiedLinkError` |
| STL 冲突 | ⚠️ 运行期崩溃 | 不要自定义 STL |

---

# 6. Android.mk 源码对照说明

以官方 `builds/android_ndk_jni_mk` 为参考：

## 6.1 `apk_patch.cpp`

- 提供 `ApkPatch()` 的外部调用入口
- 参数校验 + 错误码转换
- **不是算法实现**

## 6.2 `src/patch/*`

- patch 文件解析
- 差分指令调度
- entry 级别的恢复流程控制

缺失后果：无法解析 patch，直接返回失败

## 6.3 `src/zip_patch.cpp`

- ZIP Central Directory 精确重建
- entry 顺序、offset、alignment 保持

> **V2/V3 签名能否通过的决定性文件**

## 6.4 `HDiffPatch/`

- 二进制级差分还原算法
- patch 指令执行核心

## 6.5 `lzma/`

- patch 数据的压缩 / 解压
- 缺失将导致 patch 无法解码

## 6.6 `zlib-1.3.1/`

- ZIP entry 的 deflate / inflate
- APK 本质是 ZIP，zlib 是基础依赖

---

# 7. 为什么客户端不能编译这些文件？

| 文件 | 原因 |
|------|------|
| `src/diff/*` | 仅用于生成 patch |
| `src/normalized/*` | 仅用于服务端 APK 归一化 |
| `zip_diff.cpp` | 服务端 zip 差分 |
| `apk_normalized.cpp` | 服务端工具 |

---

# 8. NDK 版本兼容性

| NDK 版本 | 状态 |
|---------|------|
| r21e ~ r25 | ✅ 文档推荐，长期验证 |
| r26 ~ r27 | ✅ 实测可用 |
| < r21 | ⚠️ 可能有问题 |

---

# 9. 调试技巧

## 9.1 检查 patch 返回值

```cpp
TPatchResult ret = ApkPatch(oldApk, patch, newApk, 0, nullptr, 1);
// PATCH_SUCCESS = 0
// 其他值表示失败
```

## 9.2 验证输出 APK

```bash
# 检查 APK 完整性
aapt dump badging new.apk

# 验证签名
apksigner verify --verbose new.apk
```

## 9.3 对比文件 hash

```bash
# 服务端生成的目标 APK hash
sha256sum expected_new.apk

# 客户端合成的 APK hash
sha256sum new.apk

# 两者必须完全一致
```

