# 1. ApkPatch 工作原理

## 1.1 核心操作
整个ApkPatch一共有三大核心操作：diff、normalized和patch
### 1.1.1 Normalized操作
**目的**
**原因**
### 1.1.2 Diff操作
**目的**
### 1.1.3 Patch操作
**目的**
## 1.2 核心职责

1. 打开旧 APK（sourceDir）
2. 顺序解析 ZIP Central Directory
3. 读取 patch 中的重建指令
4. 使用 HDiffPatch 还原 entry 内容
5. **按原顺序写入 ZIP entry**
6. 恢复 alignment / offset
7. 完整输出 new.apk

---
# 2. 生成环境APK差分更新流程
## 2.1 APK构建流程
## 2.2 资源服差分流程
## 2.3 APK更新流程

---

# 3. APK 字节级黑名单（V2/V3 签名必死项）

> 以下行为 **只要出现一次，签名必定失效**。

## 3.1 绝对禁止的操作

- ❌ zipalign
- ❌ 重新压缩 APK
- ❌ 解压再打包
- ❌ 修改 ZIP entry 顺序
- ❌ 修改任何一个字节

## 3.2 隐性踩雷点

| 行为 | 说明 |
|------|------|
| 使用 FileOutputStream 重写 APK | 会改变 zip 结构 |
| Unity 二次拷贝 APK | 部分 ROM 会重写 header |
| 使用第三方文件管理器 | 可能触发文件系统重排 |
| Debug 构建验证 Release patch | 字节不同 |

---

# 4. 生产环境 Top 10 失败原因

1. **使用了 split APK** - Google Play 动态分发
2. **ABI 不一致** - Unity 导出与 .so 不匹配
3. **apk_patch.cpp 被修改** - 破坏了算法逻辑
4. **zipalign 被额外执行** - 某些构建工具自动执行
5. **patch 与 old.apk 不匹配** - 版本对应错误
6. **Debug / Release 构建不一致** - 字节级差异
7. **Unity Gradle 覆盖 so** - 配置问题
8. **下载 patch 未校验 hash** - 下载不完整
9. **ROM 文件系统权限问题** - 部分国产 ROM
10. **多进程并发 patch** - 文件锁冲突

---

# 5. 常见错误速查表

| 问题 | 是否影响 so | 说明 |
|------|------------|------|
| applicationId 不一致 | ❌ 不影响 | so 与包名无关 |
| JNI 类名不一致 | ✅ 致命 | 找不到 native 方法 |
| compileSdk 过低 | ❌ 不影响 | 仅影响 Java 层 |
| minSdk < 21 | ⚠️ 风险 | 老系统不建议 |
| targetSdk 提升 | ❌ 不影响 | 运行时行为不变 |
| 未链接 android 库 | ⚠️ 可能链接失败 | `AAssetManager` 未定义 |
| 未开启大文件支持 | ⚠️ 潜在编译错误 | `off64_t` 相关问题 |
| ABI 不一致 | ✅ 运行时崩溃 | `UnsatisfiedLinkError` |
| STL 冲突 | ⚠️ 运行期崩溃 | 不要自定义 STL |

---

# 6. Android.mk 源码对照说明

以官方 `builds/android_ndk_jni_mk` 为参考：

## 6.1 `apk_patch.cpp`

- 提供 `ApkPatch()` 的外部调用入口
- 参数校验 + 错误码转换
- **不是算法实现**

## 6.2 `src/patch/*`

- patch 文件解析
- 差分指令调度
- entry 级别的恢复流程控制

缺失后果：无法解析 patch，直接返回失败

## 6.3 `src/zip_patch.cpp`

- ZIP Central Directory 精确重建
- entry 顺序、offset、alignment 保持

> **V2/V3 签名能否通过的决定性文件**

## 6.4 `HDiffPatch/`

- 二进制级差分还原算法
- patch 指令执行核心

## 6.5 `lzma/`

- patch 数据的压缩 / 解压
- 缺失将导致 patch 无法解码

## 6.6 `zlib-1.3.1/`

- ZIP entry 的 deflate / inflate
- APK 本质是 ZIP，zlib 是基础依赖

---

# 7. 为什么客户端不能编译这些文件？

| 文件 | 原因 |
|------|------|
| `src/diff/*` | 仅用于生成 patch |
| `src/normalized/*` | 仅用于服务端 APK 归一化 |
| `zip_diff.cpp` | 服务端 zip 差分 |
| `apk_normalized.cpp` | 服务端工具 |

---

# 8. NDK 版本兼容性

| NDK 版本 | 状态 |
|---------|------|
| r21e ~ r25 | ✅ 文档推荐，长期验证 |
| r26 ~ r27 | ✅ 实测可用 |
| < r21 | ⚠️ 可能有问题 |

---

# 9. 调试技巧

## 9.1 检查 patch 返回值

```cpp
TPatchResult ret = ApkPatch(oldApk, patch, newApk, 0, nullptr, 1);
// PATCH_SUCCESS = 0
// 其他值表示失败
```

## 9.2 验证输出 APK

```bash
# 检查 APK 完整性
aapt dump badging new.apk

# 验证签名
apksigner verify --verbose new.apk
```

## 9.3 对比文件 hash

```bash
# 服务端生成的目标 APK hash
sha256sum expected_new.apk

# 客户端合成的 APK hash
sha256sum new.apk

# 两者必须完全一致
```

