# ApkDiffPatch Android 客户端接入指南

## 1. 文档目的与适用范围

本文档用于指导在**生产环境**下，将 **ApkDiffPatch** 以 **Android Native Library（.so）** 的形式集成到 **Unity Android 客户端** 中，实现 APK 差分合成更新能力。

### 1.1 适用前提（必须满足）

- 研发团队 **掌握 APK 最终签名权**
- 所有发布 APK 使用 **同一套签名证书**
- 不存在第三方渠道二次签名
- APK 使用 V2/V3 签名（主流场景）
- 客户端允许弹窗安装更新（非静默）

> ⚠️ 若上述任一条件不满足，本方案不可用。

### 1.2 文档结构

| 文档                                   | 内容                         |
| ------------------------------------ | -------------------------- |
| [01_概述与快速开始.md](01_概述与快速开始.md)       | 本文档，技术背景与快速入门              |
| [02_NDK构建指南.md](02_NDK构建指南.md)       | CMakeLists.txt、构建步骤、常见编译问题 |
| [03_Unity集成指南.md](03_Unity集成指南.md)   | .so 文件放置、JNI 调用、ABI 校验     |
| [04_服务端Patch生成.md](04_服务端Patch生成.md) | patch 生成与验证流程              |
| [05_原理与排错.md](05_原理与排错.md)           | 工作原理、失败原因、签名问题             |

---

## 2. ApkDiffPatch 技术本质说明

ApkDiffPatch **不是 SDK，也不是库形态产品**，而是一个：

> **跨平台 C++ 工具型源码工程**

其核心特点：

- 不关心 Android Framework
- 不处理签名
- 不做 zipalign
- 不修改任何 APK 结构语义

客户端的唯一职责：

> 使用【当前设备上真实安装的 APK 字节流】 +【服务器生成的 patch】 → **还原出一个字节级一致的新 APK**

---

## 3. 官方仓库结构

仓库地址： [https://github.com/sisong/ApkDiffPatch](https://github.com/sisong/ApkDiffPatch)

```
ApkDiffPatch/
├─ builds/
│  └─ android_ndk_jni_mk/   # 官方 Android NDK 示例
├─ HDiffPatch/              # ★ 差分算法核心
├─ lzma/                    # ★ 压缩算法
├─ zlib-1.3.1/              # ★ zlib
├─ src/
│  ├─ diff/                 # 服务端用
│  ├─ patch/                # ★ 客户端核心
│  ├─ normalized/           # 服务端用
│  └─ zip_patch.cpp         # ★ ZIP/APK 合成
└─ ...
```

### 客户端必须编译的部分

| 目录/文件 | 作用 |
|----------|------|
| `src/patch/` | patch 合成逻辑 |
| `src/zip_patch.cpp` | ZIP/APK 重建 |
| `HDiffPatch/` | 差分算法核心 |
| `lzma/` | 压缩解压 |
| `zlib-1.3.1/` | ZIP 支持 |

### 客户端不需要的部分

- `src/diff/` - 服务端差分生成
- `src/normalized/` - APK 归一化
- `zip_diff.cpp` - 服务端用
- `apk_normalized.cpp` - 服务端用

---

## 4. 快速开始

### 4.1 构建环境

| 工具 | 推荐版本 |
|------|---------|
| Android Studio | Flamingo+ |
| Android NDK | r21e ~ r27 |
| CMake | 3.10+ |
| ABI | arm64-v8a |

### 4.2 最小工程结构

```
app/src/main/cpp/
├─ apk_patch.cpp             # 来自官方示例
├─ apk_patch.h
├─ src/
│  ├─ patch/
│  └─ zip_patch.cpp
├─ HDiffPatch/
├─ lzma/
├─ zlib1.3.1/
├─ android_jni.cpp           # JNI 封装
└─ CMakeLists.txt
```

### 4.3 构建命令

```bash
./gradlew assembleRelease
```

### 4.4 输出位置

```
# 新版 AGP (≥ 7.0)
app/build/intermediates/cxx/Release/<hash>/obj/arm64-v8a/libapkpatch.so
```

> ⚠️ 此目录下的 .so 仍包含调试符号（~2.7MB），生产环境应使用 strip 后版本（~760KB）

---

## 5. 总结

ApkDiffPatch 在客户端并不是"集成 SDK"，而是：

> **直接把 C++ 差分工具链编进 App 内**

成功的唯一前提：

- 统一签名
- 统一构建
- 统一发布链路

---

## 下一步

- 详细构建配置 → [02_NDK构建指南.md](02_NDK构建指南.md)
- Unity 集成 → [03_Unity集成指南.md](03_Unity集成指南.md)
