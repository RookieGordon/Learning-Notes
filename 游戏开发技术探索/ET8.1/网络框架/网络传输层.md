---
tags:
  - ET8/网络框架
---
网络传输层

# 三种传输协议

| 协议 | 类 | 特点 | 用途 |
|---|---|---|---|
| **KCP/UDP** | `KService` + `KChannel` | 可靠 UDP，低延迟 | 客户端 ↔ 服务器（游戏数据） |
| **TCP** | `TService` + `TChannel` | 稳定可靠，有序 | 服务器 ↔ 服务器（内网通信） |
| **WebSocket** | `WService` + `WChannel` | 浏览器兼容 | WebGL 客户端 |

# KCP 协议简介

KCP 是一个基于 UDP 的可靠传输协议。为什么不直接用 TCP？

| | TCP | KCP/UDP |
|---|---|---|
| 延迟 | 较高（Nagle 算法、拥塞控制保守） | 更低（可配置激进重传） |
| 头部开销 | 20+ 字节 | 自定义，更精简 |
| NAT 穿透 | 困难 | 相对容易 |
| 丢包处理 | 重传整个窗口 | 选择性重传 |

对于游戏来说，**低延迟**比带宽效率更重要，因此 KCP 是更好的选择。

# 消息包格式

**Outer 消息**（客户端 ↔ 服务器）：
```
[2字节 Opcode] [消息体 MemoryPack序列化]
```

**Inner 消息**（服务器 ↔ 服务器）：
```
[2字节 Opcode] [16字节 ActorId] [消息体 MemoryPack序列化]
```

Inner 消息额外包含 `ActorId`（8字节 Address + 8字节 InstanceId），用于在目标进程中精确路由到目标 Entity。

# KService 的连接管理

KService 实现了自定义的**四阶段握手**协议：

```
客户端                  服务器
  |--- SYN(localConn) -->|       // 1. 客户端发起连接
  |<-- ACK(localConn,   |       // 2. 服务器分配远程连接ID
  |    remoteConn) ------|
  |--- MSG(data) ------->|       // 3. 开始正常通信
  |--- FIN ------------->|       // 4. 断开连接
```

# 大消息分片

KCP 消息有大小限制（`MaxKcpMessageSize = 10000` 字节）。超过此大小的消息会自动**分片/重组**：

```
大消息 (30000 bytes)
    ↓ 分片
[Fragment 1: 10000B] [Fragment 2: 10000B] [Fragment 3: 10000B]
    ↓ 逐个发送
    ↓ 接收端重组
原始消息 (30000 bytes)
```

---
