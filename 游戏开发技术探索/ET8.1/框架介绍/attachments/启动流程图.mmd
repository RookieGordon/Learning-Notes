
flowchart TD
    A["**入口 Init**"] --> B{"运行环境?"}

    B -->|"Unity 前端<br/>(MonoBehaviour.Start)"| C1["DontDestroyOnLoad(gameObject)"]
    B -->|"DotNet 后端<br/>(Init.Start)"| C2["解析命令行参数<br/>ParseArguments&lt;Options&gt;<br/>(System.Environment.GetCommandLineArgs)"]

    C1 --> D1["解析命令行参数<br/>ParseArguments&lt;Options&gt;<br/>(空字符串 split)"]
    D1 --> D1a["设置 StartConfig<br/>Options.Instance.StartConfig<br/>= StartConfig/Localhost"]
    D1a --> E1["AddSingleton&lt;Logger&gt;<br/>→ UnityLogger"]

    C2 --> E2["AddSingleton&lt;Logger&gt;<br/>→ NLogger"]

    E1 --> F["**公共初始化流程**"]
    E2 --> F

    F --> G["ETTask.ExceptionHandler += Log.Error"]
    G --> H["AddSingleton&lt;TimeInfo&gt;"]
    H --> I["AddSingleton&lt;FiberManager&gt;"]

    I --> J{"运行环境?"}

    J -->|"Unity 前端"| K1["await AddSingleton&lt;ResourcesComponent&gt;<br/>.CreatePackageAsync(DefaultPackage)"]
    K1 --> K2["AddSingleton&lt;CodeLoader&gt;"]
    K2 --> K3["await codeLoader.DownloadAsync()"]
    K3 --> K4["codeLoader.Start()"]

    J -->|"DotNet 后端"| L1["AddSingleton&lt;CodeLoader&gt;<br/>(构造中自动启动)"]

    K4 --> M["**公共主循环**"]
    L1 --> M

    M --> N["Update()"]
    N --> N1["TimeInfo.Instance.Update()"]
    N1 --> N2["FiberManager.Instance.Update()"]

    N2 --> O["LateUpdate()"]
    O --> O1["FiberManager.Instance.LateUpdate()"]
    O1 --> N

    style A fill:#4A90D9,color:#fff,stroke:#2C5F8A
    style F fill:#F5A623,color:#fff,stroke:#C4841A
    style M fill:#7ED321,color:#fff,stroke:#5B9A18
    style B fill:#BD10E0,color:#fff,stroke:#8B0BA6
    style J fill:#BD10E0,color:#fff,stroke:#8B0BA6
