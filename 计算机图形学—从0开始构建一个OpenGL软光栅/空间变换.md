---
tags:
  - 图形学
  - 软光栅
---
# 二维空间变换
## 二维旋转

![[（图解16）二维逆时针旋转操作.png|353]]

二维逆时针旋转矩阵：
$$\begin{align}
R_{\theta} & = \begin{bmatrix}  
  \cos \theta  & -\sin \theta \\  
  \sin \theta  & \cos \theta
\end{bmatrix} 
\end{align}$$

## 二维平移矩阵
![[（图解17）二维平移操作.png|423]]

### 齐次坐标

为了迎合平移变换，且能相乘的形式。我们为每一个顶点或向量坐标加一个维度，让二维向量升为三维向量。如果是点的形式，就补一个1，如果是向量，就补一个0。
![[（图解18）点和向量的齐次坐标.png|632]]
因为向量是位置信息的，所以补一个0后，用平移矩阵对一个向量做平移操作，结果不变。但是一个点再经过平移操作后，位置会发生变化，这样就要求补一个1。

二维平移矩阵：
$$\begin{align}
T & = \begin{bmatrix}  
  1  & 0 & t_{x} \\
  0  & 1 & t_{y} \\
  0  & 0 & 1 \\
\end{bmatrix} 
\end{align}$$

# 三维空间变换

三维坐标系的基向量(X/Y/Z)根据排列不同，分为左手坐标系与右手坐标系。
![[（图解19）左手和右手坐标系.png|440]]
`在哪种坐标系中，叉乘就要用哪个手来判断方向。`

## 三维旋转操作

三维空间操作中的平移和缩放操作，都可以直接在二维的基础上进行升维类比。

三维空间中的旋转是围绕一个旋转中心轴。对于绕某个轴旋转$\theta$角，是指逆着当前轴（从正方向）看过去，逆时针旋转旋转$\theta$角。

绕z轴逆时针旋转矩阵为：
$$\begin{array}{c}
R_{\theta} = \begin{bmatrix}  
  \cos \theta  & -\sin \theta  & 0 & 0 \\  
  \sin \theta  & \cos \theta   & 0 & 0 \\  
    0          &   0           & 1 & 0 \\
    0          &   0           & 0 & 1
\end{bmatrix} 
\end{array}$$

绕x轴逆时针旋转矩阵为：
$$\begin{array}{c}
R_{\theta} = \begin{bmatrix}  
    1          &   0           & 0 & 0 \\
  \cos \theta  & -\sin \theta  & 0 & 0 \\  
  \sin \theta  & \cos \theta   & 1 & 0 \\  
    0          &   0           & 0 & 1 \\
\end{bmatrix} 
\end{array}$$

绕y轴逆时针旋转矩阵为：
$$\begin{array}{c}
R_{\theta} = \begin{bmatrix}  
  \cos \theta  & \sin \theta   & 0 & 0 \\  
    0          &   1           & 0 & 0 \\
  -\sin \theta & \cos \theta   & 1 & 0 \\  
    0          &   0           & 0 & 1 \\
\end{bmatrix} 
\end{array}$$
 
### 三维空间旋转任意轴的旋转矩阵

如果将点看成是单位向量的缩放结果，那么旋转操作的几何意义就是坐标系的旋转。

已知旋转轴为u轴，v绕其旋转$\theta$角，得到$v'$，求$v'$的坐标：
![[（图解20）任意轴旋转推导过程1.png|350]]

**<font color="#ffff00">求解思路：</font>**
![[（图解21）求旋转矩阵的一组基向量.png|559]]

根据向量点乘的几何意义有：
$$\begin{align}
\vec{v_{\parallel}} & = (\vec{v}\cdot \vec{u})\cdot \vec{u}\\
\vec{v_{\perp}} & = \vec{v} - \vec{v_{\parallel}}
\end{align}$$

从$u$轴正方向看过去（顶部俯视图），求$\vec{v'_{\perp}}$还需要构造纵坐标向量$\vec{w}$。
![[（图解22）任意轴旋转推导过程2.png|459]]

根据$\vec{v'_{\perp}}$产生的方向，可以得到$\vec{w}$的方向就是$\vec{u} \times\vec{v_{\perp}}$。再根据三角形可以得到：
$$\vec{v'_{\perp}} = \cos \theta \vec{v_{\perp}} + \sin \theta(\vec{u} \times\vec{v_{\perp}})$$
将前面的公式带入，最终可得：
$$\vec{v'_{\perp}} = \cos \theta (\vec{v} - (\vec{v}\cdot \vec{u})\cdot \vec{u}) + \sin \theta(\vec{u} \times\vec{v}) + (\vec{v}\cdot \vec{u})\cdot\vec{u}$$

分别令$\vec{v}$等于(1,0,0)，(0,1,0)，(0,0,1)可以得到，旋转轴为u轴，v绕其旋转$\theta$角的旋转矩阵为：
![[（图解23）任意轴的旋转矩阵.png|669]]

# 视图变换

## 摄像机

摄像机的参数有：==位置，摄像机的观察方向，摄像机的正上方方向，摄像机视张角==。初始状态下，==摄像机位于原点，观察方向为负Z轴方向==。

### 摄像机的空间变换

摄像机的变换操作只有平移和旋转。最终变换矩阵$M = T*R$（==先平移再旋转==）。

> `由于摄像机的空间变换的复杂性，以及投影需求的不变性。考虑将目标物体和摄像机同时逆变换到摄像机的初始状态，可以大大降低投影的复杂度，并且由于物体与摄像机的相对位置不变，投影的结果也是不变的。`

### 摄像机逆变换矩阵

已知摄像机当前的观察方向向量$front$（归一化向量）和位置p
![[（图解24）摄像机逆变换矩阵.png|544]]

由任意轴旋转矩阵可得，xyz坐标系旋转变换到了ru-f坐标系。在已知摄像机正上方和观察方向时，可以通过两者叉乘得到r向量，进而得到u向量，所以有，摄像机的旋转矩阵为：
![[（图解25）摄像机的旋转矩阵和逆矩阵.png|561]]
摄像机的平移矩阵为：
![[（图解26）摄像机的平移矩阵和逆矩阵.png|583]]

### 摄像机视图变换矩阵（View Matrix）

将摄像机变换到目标状态的矩阵为：
![[（图解27）摄像机空间变换矩阵.png|628]]

View Matrix即摄像机变换到目标状态的逆矩阵，作用是将摄像机变换回到初始状态。
![[（图解28）摄像机的视图变换矩阵.png|655]]

# 投影变换

## 正交投影变换

### 正交投影盒空间和正交投影平面

正交投影盒空间是指，定义一个立方体，只有在立方体内的物体才会“可视”，其他的都看不到；即在视图变换后的结果中，选择一块区域进行渲染显示。
![[（图解31）正交投影盒空间.png|397]]

投影平面唯一投影盒正Z轴方向的面：
![[（图解32）正交投影平面与屏幕.png|450]]

有了正交投影盒空间后，需要将其进行规范操作：
- 盒中心位于原点
- 盒子为长度为2的正方体，即坐标在（-1.1）之间

### 投影盒平移矩阵

盒中心点$center = (\frac{r+l}{2}, \frac{t+b}{2} , \frac{n+f}{2})$，那么将中心点归零的变换矩阵为：
![[（图解33）正交投影盒逆平移矩阵.png|265]]

### 投影盒的缩放矩阵

同样的变换也施加到盒体内的物体上，这样物体顶点坐标都会被放缩到-1到1，这种坐标称为``NDC坐标（标准设备坐标-Normalized Device Coordinates)``
![[（图解34）正交投影盒的逆缩放矩阵.png|284]]

> 对于盒子的x和y轴，1落在正方向，-1落在负方向。但是对于z轴来说，由于摄像机的观察方向为z轴负方向，所以，1落在了z轴的负方向，-1在z轴的正方向。
![[（图解35）正交投影盒的三个轴方向.png|436]]

### 正交投影矩阵

将平移和缩放结合起来，经过正交投影变换后，物体中点的变换如下：
- 盒体内的顶点，坐标xyz都缩放在了(-1,1)以内的NDC坐标
- 盒体外的顶点，坐标xyz缩放后，至少某一维度坐标会小于-1或者大于1

![[（图解36）正交投影矩阵.png|651]]

`注意观察投影盒子，可以发现，从定义上讲，near < far, 那么投影盒子是一个左手坐标系，也就是说，将物体变换到投影盒子后，物体的坐标系发生了手性变化，从右手坐标系变成了左手坐标系！` ^ab9047

## 透视投影变换

![[（图解40）透视投影图示.png|497]]
从摄像机出发，看向-z方向，所有物体被投影到近平面near上。

`正交盒子中，near和far可正可负，但是视锥体中，near和far表示可视范围，都是正数`
![[（图解41）视锥体参数定义.png|479]]
与正交盒子不同，left、right、top和bottom都是描述的近平面。

### 透视投影盒空间

透视投影变换最终目的，是将视锥体内部的物体压缩到一个xyz为-1到1的盒体内，即物体坐标化为NDC坐标，从而与正交投影统一后续计算
![[（图解42）视锥体的投影盒子.png|595]]

### 投影平面坐标计算

**e(eye)坐标**：视图变换后的坐标，逆着y轴看，得到如下图像：
![[（图解43）投影坐标y轴俯视图.png|434]]
根据相似三角形可以得到：
$$\begin{align}
\frac{x_{p} }{x_{e} } & = \frac{-n}{z_{e} } \\
x_{p} &= \frac{-n * x_{e} }{z_{e} } = \frac{n * x_{e} }{-z_{e} }   
\end{align}$$

逆着x轴看，有：
![[（图解44）投影坐标x轴俯视图.png|476]]
$$\begin{align}
z_{e} &\ne 0 \\
\frac{y_{p} }{y_{e} } & = \frac{-n}{z_{e} } \\
y_{p} &= \frac{-n * y_{e} }{z_{e} } = \frac{n * y_{e} }{-z_{e} }   
\end{align}$$

### 投影平面和NDC

已知视锥体中的点投影到近平面的P点的坐标，然后需要将其缩放到(-1,1)的NDC坐标中。 

近平面上的点与NDC坐标是线性对应的。如下图，$y_{p}$从bottom到top，对应$y_{ndc}$从-1到1。
![[（图解4）视锥体的近平面与NDC线性对应.png|296]]
通过这样一个直线方程，就可以得出近平面点的y值与NDC空间中的y值的关系：
$$\begin{align}
y_{ndc} &= \frac{1- (-1)}{t - b} * y_{p} + \beta \\
其中有：1 &= \frac{2t}{t - b} + \beta; \beta = -\frac{t+b}{t-b} \\
有：y_{ndc} &= \frac{2}{t - b} * y_{p} -\frac{t+b}{t-b}
\end{align}$$

同理，可以得到x值的对应关系：
$$x_{ndc} = \frac{2}{r - l} * x_{p} -\frac{r+l}{r-l}$$
 又因为：$x_{p}  = \frac{n * x_{e} }{-z_{e} }$，$y_{p} = \frac{n * y_{e} }{-z_{e} }$，在$z_{e} \ne 0$的条件下有：
 ![[（图解45）视锥体中点的x值对应的NDC值.png|299]]
![[（图解46）视锥体中点的y值对应的NDC值.png|309]]

考虑兼容$z_{e}=0$的情况，用齐次坐标表达NDC内的点$p_{c}$有：
$$p_{c} = [x_{ndc}*(-z_{e}), \quad y_{ndc}*(-z_{e}), \quad z_{ndc}*(-z_{e}), \quad -z_{e}]$$
>对$p_{c}$来说：
>1、是一个齐次坐标，三维数据需要除以$w$
>2、其出现是为了兼容$z_{e}=0$情况下的表达
>3、其中c的含义是clip，以后其会被用于剪裁空间剪裁

构建出$p_{c}$后，可以得到投影变换矩阵为：
![[（图解47）透视投影变换矩阵方程.png|507]]
任取近平面上的点，可知$z_{e}=-n, z_{ndc} =-1$。任取远平面上的点，可知$z_{e}=一f, z_{ndc}=1$，从而有：
![[（图解48）求解透视投影矩阵方程中的未知数.png|504]]

最终有，透视投影矩阵为：
![[（图解49）透视投影矩阵.png|410]]

`注意：转换到剪裁空间，没有做除以w的操作，即没有做透视除法`

### 透视投影矩阵

一般情况下，构造透视投影矩阵需要如下参数及条件：
- 近平面n，远平面f
- y方向视张角fovy
- 近平面横/纵的百分比aspect
- 近平面相对y轴左右对称，相对x轴上下对称
![[（图解50）视张角图示.png|292]]
由图，可以得知：
![[（图解51）视张角和横纵比定义.png|357]]

最终，在已知近平面，远平面，视张角和近平面横纵比这些条件下，透视投影矩阵为：
![[（图解52）透视投影矩阵.png|488]]

# 屏幕空间变换

>初始状态下，物体$A$的模型空间和世界空间重合。经过一系列操作（旋转，平移和缩放）到了$A_{1}$状态，这些操作组合成了模型矩阵$M_{A}$。
>摄像机$C$进行了另外操作，到了$C_{1}$状态，摄像机的操作组合成了矩阵M，其视图变换矩阵为$V_{C} = M^{-1}$
>这时候，在通过摄像机观察物体时，会使用视图变换矩阵，将摄像机和$A_{1}$变换回到摄像机的初始状态，即$A_{2} = V_{C} * A_{1}$，此时，物体相对于摄像机，状态没有任何变化。
>最后，使用投影变换矩阵$PM$，将$A_{2}$变换到投影盒中，即$A_{CP} = OM * A_{2}$。注意，这时候，变换$A_{cp}$位于裁剪空间，还未经过透视除法。

每个屏幕/窗体，都有自己独特的宽度跟高度，屏幕空间变换，是将NDC坐标表示的顶点，映射到屏幕/窗体具体的像素位置的过程

## 透视除法 

>物体的顶点经过透视投影矩阵变换后，会得到一个剪裁空间的顶点坐标，即$w = -z$。只有x/y/z都除以$w$之后，才能得到最终的NDC坐标。注意：
>1、这一步会出现$w=0$的可能，所以在除法前已经做了剔除（自动裁剪环节会先剔除掉$w=0$的点）
>2、正交投影后也需要除以$w$，保持流程统一性，只不过$w=1$

由于NDC坐标范围为(-1,1)，将其变换到(0,1)后，有：
$$\begin{align}
x'_{s} & = (x_{ndc} + 1) / 2 \\
y'_{s} & = (y_{ndc} + 1) / 2 \\
z'_{s} & = (z_{ndc} + 1) / 2 \\
\end{align}$$
![[（图解37）改造后的NDC与屏幕对应关系.png|571]]
盒体内物体顶点，改造为0-1区间后，其xy坐标，可以视作在屏幕上的比例，从而可以计算在屏幕上的位置：
$$\begin{align}
screenX & = 0.2 * 800 = 160 \\
screenY &= 0.6 * 600 = 360
\end{align}$$
对于任何一个NDC坐标下的顶点，变换到屏幕空间，其x/y/z都会经历如下过程：
![[（图解38）NDC变换到屏幕坐标的过程.png|666]]

所以有，屏幕空间变换矩阵（从NDC坐标变换到屏幕空间坐标）为：
![[（图解39）屏幕空间变换矩阵.png|465]]
