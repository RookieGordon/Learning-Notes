---
tags:
  - DateTime
  - 时区
  - 服务器时间
  - 本地时间
---
# 游戏时区问题
时区问题是海外发行游戏常见问题，标准解决方法是通过服务器下发的时间戳和时区id，在客户端维护一个服务器时间对象，所有通过该`ServerTime`代替客户端的`DateTime.Now`。
当然，如果服务器和客户端不存在时间差，那么大部分情况下，都可以直接使用UTC时间解决问题，尽量不要使用本机时间。
# 是不是搞复杂了？应该只是需要一个差值即可？
```CSharp
public class ServerTime  
{  
    /// <summary>  
    /// 服务器的时区信息  
    /// </summary>  
    private static TimeZoneInfo _serverTimeZone;  
  
    /// <summary>  
    /// 服务器与客户端之间的时差  
    /// </summary>  
    private static TimeSpan _timeDifference;  
  
    /// <summary>  
    /// IANA 时区标识符 -> Windows 时区标识符的映射表  
    /// </summary>  
    private static readonly Dictionary<string, string> _IANAtoWindowsMap = new Dictionary<string, string>  
    {  
        { "UTC", "UTC" },  
        { "Asia/Shanghai", "China Standard Time" },  
        { "America/New_York", "Eastern Standard Time" },  
        { "Europe/London", "GMT Standard Time" },  
        { "Asia/Tokyo", "Tokyo Standard Time" },  
        { "Australia/Sydney", "AUS Eastern Standard Time" },  
        // 根据需要扩充映射表。  
    };  
  
    /// <summary>  
    /// 初始化服务器时间戳和 IANA 时区（程序启动时调用一次）
    /// </summary>  
    public static void InitializeServerTime(long serverUTCTimestamp, string serverIanaTimeZoneId)  
    {        
        // 将 IANA 时区转换为 Windows 时区  
        string windowsTimeZoneId = ServerTime._ConvertIanaToWindows(serverIanaTimeZoneId);  
        if (string.IsNullOrEmpty(windowsTimeZoneId))  
        {            
            throw new TimeZoneNotFoundException($"无法找到对应的时区映射，IANA标识符: {serverIanaTimeZoneId}");  
        }  

        // 获取服务器的时区信息  
        ServerTime._serverTimeZone = TimeZoneInfo.FindSystemTimeZoneById(windowsTimeZoneId);  
        // 计算客户端 UTC 时间与服务器 UTC 时间的时差  
        DateTime serverUtcTime = DateTimeOffset.FromUnixTimeSeconds(serverUTCTimestamp).UtcDateTime;  
        DateTime clientUtcTime = DateTime.UtcNow;  
        ServerTime._timeDifference = serverUtcTime - clientUtcTime;  
    }  

    /// <summary>  
    /// 实时获取服务器当前时间
    /// </summary>  
    public static DateTime GetServerCurrentTime()  
    {        
        // 获取当前客户端 UTC 时间  
        DateTime clientUtcNow = DateTime.UtcNow;  
        // 加入时间差，计算服务器 UTC 时间  
        DateTime serverUtcNow = clientUtcNow + ServerTime._timeDifference;  
        // 将 UTC 时间转换为服务器所在时区时间  
        DateTime serverLocalTime = TimeZoneInfo.ConvertTimeFromUtc(serverUtcNow, ServerTime._serverTimeZone);  
  
        return serverLocalTime;  
    }  

    public static long GetServerTimestamp()  
    {        
        // 根据指定的时区将时间转换为 UTC        
        DateTime utcTime = TimeZoneInfo.ConvertTimeToUtc(GetServerCurrentTime(), ServerTime._serverTimeZone);  
        // Unix 纪元时间 (1970-01-01 00:00:00 UTC)        
        DateTimeOffset unixEpoch = DateTimeOffset.UnixEpoch;  
        // 计算时间戳（秒）  
        long unixTimestamp = (long)(utcTime - unixEpoch.UtcDateTime).TotalSeconds;  
        return unixTimestamp;  
    }  

    /// <summary>  
    /// 将 IANA 时区标识符转换为 Windows 时区标识符
    /// </summary>  
    private static string _ConvertIanaToWindows(string ianaTimeZoneId)  
    {        
        if (ServerTime._IANAtoWindowsMap.TryGetValue(ianaTimeZoneId, out string windowsTimeZoneId))  
        {            
            return windowsTimeZoneId;  
        }  
        return null;    
    }  
}
```